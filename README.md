# Сервис API Gateway

## Описание

API Gateway — это централизованный входной узел для всех клиентских запросов к микросервисам телекоммуникационной системы. Сервис обеспечивает маршрутизацию запросов, аутентификацию пользователей, и применение общих политик доступа.

## Назначение

API Gateway выполняет следующие функции:
- Маршрутизация запросов к соответствующим микросервисам
- Проверка JWT-токенов и авторизация пользователей
- Передача идентификационных данных пользователя между сервисами
- Обеспечение единой точки входа для всех клиентских приложений
- Балансировка нагрузки между экземплярами микросервисов

## Логика работы

### Проверка JWT-токенов

1. Для защищенных маршрутов API Gateway применяет фильтр `JwtHeaderFilter`
2. Фильтр извлекает JWT-токен из заголовка `Authorization`
3. Если заголовок отсутствует или не начинается с "Bearer ", возвращается статус 401 Unauthorized
4. Извлеченный токен отправляется на проверку в SSO-сервис через эндпоинт `/auth/introspection`
5. SSO-сервис проверяет валидность и срок действия токена, возвращает информацию о пользователе
6. Если токен действителен (поле `active: true`):
   - Из полученных данных извлекаются идентификатор пользователя (`ref_id`) и его роль (`role`)
   - К запросу добавляются заголовки `X-User-Id` и `X-User-Role`
   - Запрос передается дальше по цепочке фильтров к целевому сервису
7. Если токен недействителен:
   - Возвращается статус 401 Unauthorized
   - Запрос не передается дальше

### Обработка специальных случаев

- Если `ref_id` отсутствует (обычно для менеджеров), в заголовок `X-User-Id` записывается значение "MANAGER"
- Если при проверке токена произошла ошибка, запрос считается неавторизованным (401)
- Логируется информация о каждом этапе проверки запроса для диагностики проблем


## API Маршруты

API Gateway обеспечивает маршрутизацию к следующим сервисам:

- **SSO Service**: Аутентификация и авторизация
  - `/auth/**` → SSO-service

- **CRM Service**: Управление абонентами
  - `/manager/**` → CRM-service (требует роль MANAGER)
  - `/subscriber/**` → CRM-service (требует роль SUBSCRIBER)


## Фильтры

### JwtHeaderFilter

Основной фильтр безопасности, который:
- Извлекает токены из заголовков
- Проверяет их валидность через SSO-сервис
- Добавляет заголовки с данными пользователя
- Блокирует неавторизованный доступ

## Технические детали

### Конфигурация

Сервис получает конфигурацию через Config Server в зависимости от окружения:
- `application-dev.yaml` для локальной разработки
- `application-docker.yaml` для развертывания в Docker

Основные конфигурационные параметры:
- `spring.cloud.gateway.routes`: Определение маршрутов
- `const.auth.introspection-uri`: URL для проверки токенов (SSO-сервис)

### Технологический стек

- **Java 17**
- **Spring Boot 3.4.4**
- **Spring Cloud Gateway 2024.0.1**: Реализация API Gateway
- **Spring Cloud Netflix Eureka Client**: Обнаружение сервисов
- **Spring Cloud Config**: Внешняя конфигурация
- **Spring WebFlux**: Реактивное программирование для высокой производительности
